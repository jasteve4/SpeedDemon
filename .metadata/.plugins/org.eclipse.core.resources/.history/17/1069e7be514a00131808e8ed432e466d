package com.mydomain;

import lejos.nxt.Button;
import lejos.nxt.LCD;
import lejos.nxt.SensorPort;
import lejos.nxt.SensorPortListener;

public class UltrasonicTest implements SensorPortListener
{
	
	int echoValue = 0;
	boolean echoState = false;
	boolean lastEchoState = false;
	long echoTimer = 0;
	
	
	public UltrasonicTest(SensorPort port) throws InterruptedException {
		// TODO Auto-generated constructor stub
		port.setMode(SensorPort.SP_MODE_OUTPUT);
		port.setSensorPin(SensorPort.SP_DIGI1, 0);
		port.addSensorPortListener(this);
		
		
		boolean portStateHigh = true;
		boolean portStateLow = true;
		int count = 0;
		
		Thread.sleep(1);
		LCD.drawString("Ultrasonic Test", 0, 0);
		long startTime = System.currentTimeMillis();
		double value = 0;
		while(!Button.ESCAPE.isDown())
		{
			if(((System.currentTimeMillis()-startTime)<1)&&(portStateHigh))
			{
				port.setSensorPin(SensorPort.SP_DIGI1, 1);
				portStateHigh = false;
			}
			else if(((System.currentTimeMillis()-startTime)>=50))
			{
				portStateHigh = true;
				portStateLow = true;
				startTime = System.currentTimeMillis();
				count++;
			}
			else if(((System.currentTimeMillis()-startTime)>=1)&&portStateLow)
			{
				port.setSensorPin(SensorPort.SP_DIGI1, 0);
				portStateLow = false;
			}
			if(count >10)
			{
				LCD.drawString("EchoTimer: " + echoTimer, 0, 1);
				count = 0;
			}
		}
		
		
	}

	public static void main(String[] args) throws InterruptedException 
	{
		// TODO Auto-generated method stub
		new UltrasonicTest(SensorPort.S1);
	}

	@Override
	public void stateChanged(SensorPort aSource, int aOldValue, int aNewValue) 
	{
		// TODO Auto-generated method stub
		echoValue =  aSource.getSensorPin(aSource.SP_DIGI0);
		if(echoValue == 0)
		{
			echoState = false;  			// Current low state of the the I/O pin
		}
		else if(echoValue != 0)		
		{
			echoState = true; 				// Current High state of the the I/O pin
		}
		if((!echoState)&&(!lastEchoState))	// if the current state and the last state is low
		{
			lastEchoState = false;
		}
		else if((!echoState)&&(lastEchoState))
		{
			lastEchoState = false;
			echoTimer = (System.nanoTime() - echoTimer)/1000;
		}
		else if((echoState)&&(!lastEchoState))
		{
			lastEchoState = true;
			echoTimer = System.nanoTime();
		}
		else if((echoState)&&(lastEchoState))
		{
			lastEchoState = true;
		}
		
	}

}
